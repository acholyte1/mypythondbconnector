import tkinter as tk
import json
import os
import sys
from tkinter import messagebox, ttk  # ë©”ì‹œì§€ ë°•ìŠ¤ (ê²½ê³ /ì—ëŸ¬ ë“± ì°½), í…Œë§ˆ ìœ„ì ¯ ëª¨ë“ˆ
from db_connector import get_connection
from select_gui import launch_select_gui
from insert_gui import launch_insert_gui
from update_gui import launch_update_gui
from delete_gui import launch_delete_gui
from encryption_util import encrypt_password, decrypt_password
from permissions import load_session_permissions

def resource_path(relative_path):
    print("resource_path")
    """PyInstaller ì‹¤í–‰ or IDE ì‹¤í–‰ ëª¨ë‘ì—ì„œ ì‘ë™í•˜ëŠ” ê²½ë¡œ ê³„ì‚°"""
    if getattr(sys, 'frozen', False):
        base_path = os.path.dirname(sys.executable)
    else:
        base_path = os.path.dirname(os.path.abspath(__file__))
    return os.path.join(base_path, relative_path)

def save_login_info(host, user, password, database):
    print("save_login_info")
    path = resource_path("login_config.json")
    with open(path, "w") as f:
        json.dump({
            "host": host,
            "user": user, 
            "password": encrypt_password(password),  # ğŸ” ì•”í˜¸í™” ì €ì¥,
            "database": database
        }, f)

def load_login_info():
    print("load_login_info")
    try:
        path = resource_path("login_config.json")
        with open(path, "r") as f:
            data = json.load(f)
            if "password" in data:
                data["password"] = decrypt_password(data["password"])  # ğŸ”“ ë³µí˜¸í™”
            return data
    except FileNotFoundError:
        return {}
    except Exception as e:
        print("âš  ë¡œê·¸ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e)
        return {}
        

def launch_login_gui():
    print("launch_login_gui")
    root = tk.Tk()
    root.title("DB ë¡œê·¸ì¸")

    # ê¸°ì¡´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    saved_info = load_login_info()
    
    # DBMS ì„ íƒ
    tk.Label(root, text="DBMS").pack()
    db_type_var = tk.StringVar(value="mysql")
    combo = ttk.Combobox(root, textvariable=db_type_var, state="readonly")
    combo['values'] = ["mysql", "postgres", "oracle", "sqlite"]
    combo.pack()

    # ìœ„ì ¯: host, port, user, password, database ì…ë ¥ í•„ë“œ
    tk.Label(root, text="Host").pack()
    entry_host = tk.Entry(root)
    entry_host.pack()
    entry_host.insert(0, saved_info.get("host", ""))
    
    tk.Label(root, text="Port").pack()
    entry_port = tk.Entry(root)
    entry_port.pack()
    entry_port.insert(0, saved_info.get("port", ""))

    tk.Label(root, text="User").pack()
    entry_user = tk.Entry(root)
    entry_user.pack()
    entry_user.insert(0, saved_info.get("user", ""))    

    tk.Label(root, text="Password").pack()
    entry_password = tk.Entry(root, show="*")
    entry_password.pack()
    entry_password.insert(0, saved_info.get("password", ""))

    tk.Label(root, text="Database").pack()
    entry_db = tk.Entry(root)
    entry_db.pack()
    entry_db.insert(0, saved_info.get("database", ""))
    
    remember_var = tk.BooleanVar(value=True if saved_info else False)
    check_remember = tk.Checkbutton(root, text="ë¡œê·¸ì¸ ì •ë³´ ê¸°ì–µí•˜ê¸°", variable=remember_var)
    check_remember.pack()
    
    def on_connect():
        print("on_connect")
        host = entry_host.get().strip()
        user = entry_user.get().strip()
        password = entry_password.get().strip()
        database = entry_db.get().strip()

        if not (host and user and password and database):
            messagebox.showwarning("ì…ë ¥ ì˜¤ë¥˜", "ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.")
            return
            
        # ì—°ê²° ì‹œë„
        conn, error = get_connection(host, user, password, database)
        # ê¶Œí•œ í™•ì¸
        load_session_permissions(conn)
        
        if error:
            messagebox.showerror("DB ì—°ê²° ì‹¤íŒ¨", error)
        else: 
            if remember_var.get():
                new_info = {
                    "host": host,
                    "user": user, 
                    "password": password,
                    "database": database
                }
                if new_info != saved_info:
                    save_login_info(host, user, password, database)
            else:
                if os.path.exists("login_config.json"):
                    os.remove("login_config.json")
            
            root.destroy()  # ë¡œê·¸ì¸ ì°½ì€ ë‹«ê³ 

            app = tk.Tk()
            app.title("DB íˆ´")
            # app.update_idletasks()
            screen_width = app.winfo_screenwidth() # í™”ë©´ í•´ìƒë„ ê°€ë¡œ
            screen_height = app.winfo_screenheight() # í™”ë©´ í•´ìƒë„ ì„¸ë¡œ
            taskbar_height = 80 # ì‘ì—…í‘œì‹œì¤„ í¬ê¸° ì¶”ì •
            app.geometry(f"{screen_width}x{screen_height - taskbar_height}+0+0") # ì „ì²´ í™”ë©´ ì‹¤í–‰

            notebook = ttk.Notebook(app)
            notebook.pack(fill="both", expand=True)
            
            # ì»¬ëŸ¼ ìƒíƒœ ë”•ì…”ë„ˆë¦¬
            state = {
                "entry_columns": [], # ì…ë ¥ì°½ì— ë³´ì—¬ì¤„ ì»¬ëŸ¼
                "full_columns": [], # í…Œì´ë¸” ì „ì²´ ì»¬ëŸ¼
                "entry_vars": {}, # ì…ë ¥ ê°€ëŠ¥í•œ ì»¬ëŸ¼ê°’ 
                "full_vars": {}, # ì „ì²´ ì»¬ëŸ¼ê°’
                "primary_key": None, # ìƒì„¸ ì¡°íšŒë¥¼ ìœ„í•œ ê¸°ë³¸í‚¤
                "is_view": False, # ë·° í…Œì´ë¸” ì—¬ë¶€
            }

            # íƒ­ í”„ë ˆì„ ìƒì„±
            frame_select = ttk.Frame(notebook)
            frame_insert = ttk.Frame(notebook)
            frame_update = ttk.Frame(notebook)
            frame_delete = ttk.Frame(notebook)

            notebook.add(frame_select, text="ì¡°íšŒ")
            notebook.add(frame_insert, text="ì…ë ¥")
            notebook.add(frame_update, text="ìˆ˜ì •")
            notebook.add(frame_delete, text="ì‚­ì œ")

            # ê¸°ì¡´ GUI ë¡œì§ì„ íƒ­ì— ì§‘ì–´ë„£ìŒ
            launch_select_gui(conn, frame_select, state)
            launch_insert_gui(conn, frame_insert, state)
            launch_update_gui(conn, frame_update, state)
            launch_delete_gui(conn, frame_delete, state)

            app.protocol("WM_DELETE_WINDOW", lambda: on_quit(conn, app))

            app.mainloop()

    tk.Button(root, text="ì ‘ì†", command=on_connect).pack(pady=10)

    try:
        root.mainloop()
        return "cancel"
    except Exception as e:
        print("âŒ GUI ì‹¤í–‰ ì¤‘ ì—ëŸ¬ : ", e)
        return "error"

def on_quit(conn, app):
    print("on_quit")
    if not messagebox.askokcancel("ì¢…ë£Œ í™•ì¸", "ì •ë§ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
        return  # ì‚¬ìš©ìê°€ ì·¨ì†Œ ëˆ„ë¥´ë©´ ì•„ë¬´ ê²ƒë„ ì•ˆ í•˜ê³  ë¦¬í„´
        
    try:
        conn.close()
        print("ğŸ”Œ DB ì—°ê²° ì¢…ë£Œë¨")
    except:
        pass
    app.destroy()